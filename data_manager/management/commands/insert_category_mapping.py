# 데이터생성기
# insert_category_mapping.py
# 상세 계층형 카테고리와 농산물 매핑 데이터를 생성
# 콘솔에 python manage.py insert_category_mapping 입력
import sqlite3
from django.core.management.base import BaseCommand
from django.conf import settings

class Command(BaseCommand):
    help = '상세 계층형 카테고리와 농산물 매핑 데이터를 생성합니다.'

    def handle(self, *args, **options):
        db_path = settings.DATABASES['default']['NAME']
    
        self.stdout.write(f"연결 시도 중인 DB 경로: {db_path}")
        
        conn = sqlite3.connect(db_path)
        cursor = conn.cursor()

        self.stdout.write("--- 카테고리 초기화 및 계층형 매핑 시작 ---")
        
        # 1. 카테고리 관련 테이블만 초기화
        # (유저 데이터나 주문 데이터는 건드리지 않고 카테고리 체계만 새로 고침)
        tables = ['Bg_Interest_category', 'Bg_Category_product_mapping']
        for table in tables:
            try:
                cursor.execute(f"DELETE FROM {table}")
                cursor.execute(f"DELETE FROM sqlite_sequence WHERE name='{table}'")
            except: pass

        # 2. 로우 데이터 가져오기
        full_list = self.get_category_raw_data()

        # 3. 카테고리 계층 삽입
        cat_id_map = {}
        current_id = 1

        for large, medium, small, items in full_list:
            if (large, 1) not in cat_id_map:
                cursor.execute("INSERT INTO Bg_Interest_category (id, category_name, parent_id, depth) VALUES (?,?,?,?)", (current_id, large, None, 1))
                cat_id_map[(large, 1)] = current_id
                current_id += 1
            
            if (medium, 2) not in cat_id_map:
                cursor.execute("INSERT INTO Bg_Interest_category (id, category_name, parent_id, depth) VALUES (?,?,?,?)", (current_id, medium, cat_id_map[(large, 1)], 2))
                cat_id_map[(medium, 2)] = current_id
                current_id += 1
            
            if (small, 3) not in cat_id_map:
                cursor.execute("INSERT INTO Bg_Interest_category (id, category_name, parent_id, depth) VALUES (?,?,?,?)", (current_id, small, cat_id_map[(medium, 2)], 3))
                cat_id_map[(small, 3)] = current_id
                current_id += 1

        # 4. 상품-카테고리 키워드 매핑
        cursor.execute("SELECT id, product_name FROM Bg_Product")
        products = cursor.fetchall()

        mapping_data = []
        for p_id, p_name in products:
            for large, medium, small, keywords in full_list:
                for word in keywords:
                    if word in p_name: 
                        mapping_data.append((p_id, cat_id_map[(small, 3)]))

        if mapping_data:
            cursor.executemany("INSERT INTO Bg_Category_product_mapping (product_id, interest_category_id) VALUES (?,?)", list(set(mapping_data)))

        conn.commit()
        conn.close()
        self.stdout.write(self.style.SUCCESS(f"성공: {len(cat_id_map)}개 카테고리 생성 및 상품 매핑이 완료되었습니다."))


    def get_category_raw_data(self):
    # (대분류, 중분류, 소분류, [관련 농산물 키워드])
        return [
            # 뷰티/피부 케어
            ("뷰티/피부 케어", "미백/톤업", "비타민C 고함량", ["키위", "딸기", "레몬", "파프리카"]),
            ("뷰티/피부 케어", "미백/톤업", "멜라닌 억제", ["토마토", "감", "자몽"]),
            ("뷰티/피부 케어", "미백/톤업", "항산화 과일", ["블루베리", "아사이베리", "포도"]),
            ("뷰티/피부 케어", "미백/톤업", "피부 정화", ["오이", "셀러리"]),
            ("뷰티/피부 케어", "미백/톤업", "피부 컨디션 회복", ["배", "사과", "복숭아"]),
            ("뷰티/피부 케어", "수분/촉촉", "수분 가득", ["수박", "참외", "배"]),
            ("뷰티/피부 케어", "수분/촉촉", "히알루론산 식품", ["콩류", "고구마"]),
            ("뷰티/피부 케어", "수분/촉촉", "수분 유지", ["아보카도", "바나나"]),
            ("뷰티/피부 케어", "수분/촉촉", "피부 진정", ["알로에", "양배추"]),
            ("뷰티/피부 케어", "수분/촉촉", "수분 손실 방지", ["견과류", "들깨"]),
            ("뷰티/피부 케어", "탄력/동안", "콜라겐 합성 도움", ["파프리카", "브로콜리"]),
            ("뷰티/피부 케어", "탄력/동안", "비타민E 풍부", ["아몬드", "해바라기씨"]),
            ("뷰티/피부 케어", "탄력/동안", "피부 장벽 강화", ["고구마", "시금치"]),
            ("뷰티/피부 케어", "탄력/동안", "노화 방지", ["토마토", "블루베리"]),
            ("뷰티/피부 케어", "탄력/동안", "피부 재생", ["단호박", "당근"]),
            ("뷰티/피부 케어", "붓기 완화", "칼륨 풍부", ["바나나", "감자"]),
            ("뷰티/피부 케어", "붓기 완화", "수분 배출", ["오이", "아스파라거스"]),
            ("뷰티/피부 케어", "붓기 완화", "순환 개선", ["생강", "마늘"]),
            ("뷰티/피부 케어", "붓기 완화", "염분 조절", ["방울토마토"]),
            ("뷰티/피부 케어", "붓기 완화", "림프 순환", ["자몽", "레몬"]),

            # 바디/운동
            ("바디/운동", "근육 생성", "식물성 단백질", ["콩", "두부", "병아리콩"]),
            ("바디/운동", "근육 생성", "아미노산 공급", ["고구마", "옥수수"]),
            ("바디/운동", "근육 생성", "근육 회복", ["바나나"]),
            ("바디/운동", "근육 생성", "철분 보충", ["시금치", "비트"]),
            ("바디/운동", "근육 생성", "고단백 견과", ["아몬드", "호두"]),
            ("바디/운동", "운동 에너지", "저GI 탄수", ["현미", "보리"]),
            ("바디/운동", "운동 에너지", "빠른 에너지", ["감자", "바나나"]),
            ("바디/운동", "운동 에너지", "지구력 강화", ["사과", "오렌지"]),
            ("바디/운동", "운동 에너지", "항산화 에너지", ["베리류", "블루베리", "딸기"]),
            ("바디/운동", "운동 에너지", "미량 영양소", ["케일", "브로콜리"]),
            ("바디/운동", "운동 후 회복", "근육 통증 완화", ["체리", "파인애플"]),
            ("바디/운동", "운동 후 회복", "피로 회복", ["배", "대추"]),
            ("바디/운동", "운동 후 회복", "전해질 보충", ["수박", "코코넛"]),
            ("바디/운동", "운동 후 회복", "항염", ["생강", "고추"]),
            ("바디/운동", "운동 후 회복", "수분 회복", ["오이", "참외"]),
            ("바디/운동", "체중 관리", "저칼로리", ["양상추", "무"]),
            ("바디/운동", "체중 관리", "식이섬유", ["귀리", "당근"]),
            ("바디/운동", "체중 관리", "포만감", ["고구마", "바나나"]),
            ("바디/운동", "체중 관리", "수분 채움", ["오이", "양배추"]),
            ("바디/운동", "체중 관리", "지방 대사 도움", ["녹차잎", "레몬"]),

            # 건강 관리
            ("건강 관리", "소화/위 건강", "속 편한 식품", ["양배추", "감자"]),
            ("건강 관리", "소화/위 건강", "소화 효소", ["파인애플", "키위"]),
            ("건강 관리", "소화/위 건강", "장 운동 촉진", ["바나나", "고구마"]),
            ("건강 관리", "소화/위 건강", "장내 환경 개선", ["배추", "마늘"]),
            ("건강 관리", "소화/위 건강", "위 보호", ["단호박", "들깨"]),
            ("건강 관리", "면역력/감기", "비타민C 보강", ["귤", "레몬", "파프리카"]),
            ("건강 관리", "면역력/감기", "항염", ["생강", "마늘"]),
            ("건강 관리", "면역력/감기", "항바이러스", ["양파", "대추"]),
            ("건강 관리", "면역력/감기", "면역 부스팅", ["버섯"]),
            ("건강 관리", "면역력/감기", "목 관리", ["배", "유자"]),
            ("건강 관리", "눈 건강", "루테인", ["시금치", "케일"]),
            ("건강 관리", "눈 건강", "베타카로틴", ["당근", "고구마"]),
            ("건강 관리", "눈 건강", "안구 건조 완화", ["아보카도"]),
            ("건강 관리", "눈 건강", "블루라이트 보호", ["블루베리"]),
            ("건강 관리", "눈 건강", "피로 눈 완화", ["오이"]),
            ("건강 관리", "만성피로", "피로회복", ["오렌지", "사과"]),
            ("건강 관리", "만성피로", "철분·혈액순환", ["비트"]),
            ("건강 관리", "만성피로", "혈당 안정", ["귀리", "보리"]),
            ("건강 관리", "만성피로", "비타민B", ["버섯"]),
            ("건강 관리", "만성피로", "스트레스 완화", ["바나나"]),

            # 식습관/식단
            ("식습관/식단", "저탄수화물", "저당 과일", ["베리류", "자몽", "블루베리", "딸기"]),
            ("식습관/식단", "저탄수화물", "저탄수 채소", ["브로콜리", "시금치"]),
            ("식습관/식단", "저탄수화물", "대체 탄수", ["콜리플라워"]),
            ("식습관/식단", "저탄수화물", "혈당관리", ["고구마"]),
            ("식습관/식단", "저탄수화물", "단백질·지방 대체", ["아보카도"]),
            ("식습관/식단", "비건/채식", "식물성 단백질", ["콩", "렌틸콩"]),
            ("식습관/식단", "비건/채식", "비건 간식", ["견과류", "아몬드", "호두"]),
            ("식습관/식단", "비건/채식", "식이섬유", ["귀리", "배추"]),
            ("식습관/식단", "비건/채식", "비타민 보충", ["당근", "버섯"]),
            ("식습관/식단", "비건/채식", "비건 철분", ["시금치", "비트"]),
            ("식습관/식단", "식감 중심", "아삭함", ["오이", "파프리카"]),
            ("식습관/식단", "식감 중심", "쫄깃함", ["버섯"]),
            ("식습관/식단", "식감 중심", "부드러움", ["아보카도"]),
            ("식습관/식단", "식감 중심", "크런치", ["견과류", "아몬드", "호두"]),
            ("식습관/식단", "식감 중심", "씹는 맛", ["당근", "무"]),
            ("식습관/식단", "간편한 식사", "즉석 과일", ["바나나", "사과"]),
            ("식습관/식단", "간편한 식사", "즉석 샐러드", ["양상추", "케일"]),
            ("식습관/식단", "간편한 식사", "즉석 스팀 채소", ["단호박"]),
            ("식습관/식단", "간편한 식사", "즉석 곡물", ["현미"]),
            ("식습관/식단", "간편한 식사", "한 끼 대용", ["고구마"]),

            # 정신/웰니스
            ("정신/웰니스", "스트레스 완화", "마그네슘", ["바나나", "아몬드"]),
            ("정신/웰니스", "스트레스 완화", "진정 효과", ["캐모마일", "레몬밤"]),
            ("정신/웰니스", "스트레스 완화", "긴장 완화", ["고구마"]),
            ("정신/웰니스", "스트레스 완화", "항산화", ["블루베리"]),
            ("정신/웰니스", "스트레스 완화", "숙면 도움", ["체리"]),
            ("정신/웰니스", "집중력 향상", "뇌 에너지", ["바나나"]),
            ("정신/웰니스", "집중력 향상", "오메가-3", ["호두", "아마씨"]),
            ("정신/웰니스", "집중력 향상", "항산화", ["블루베리"]),
            ("정신/웰니스", "집중력 향상", "혈류 개선", ["비트"]),
            ("정신/웰니스", "집중력 향상", "비타민B", ["버섯"]),
            ("정신/웰니스", "감정 안정", "세로토닌 증가", ["바나나"]),
            ("정신/웰니스", "감정 안정", "스트레스 완화", ["고구마"]),
            ("정신/웰니스", "감정 안정", "진정 허브", ["라벤더", "캐모마일"]),
            ("정신/웰니스", "감정 안정", "피로 감소", ["오렌지"]),
            ("정신/웰니스", "감정 안정", "항염 효과", ["생강"]),
            ("정신/웰니스", "활력/기분전환", "비타민C", ["레몬", "오렌지"]),
            ("정신/웰니스", "활력/기분전환", "엔도르핀 도움", ["고추"]),
            ("정신/웰니스", "활력/기분전환", "에너지 공급", ["사과"]),
            ("정신/웰니스", "활력/기분전환", "가벼운 활력", ["배"]),
            ("정신/웰니스", "활력/기분전환", "항산화", ["포도"])
        ]